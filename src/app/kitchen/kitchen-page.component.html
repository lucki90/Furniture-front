<div class="kitchen-page">
  <!-- PAGE HEADER -->
  <header class="page-header">
    <div class="page-title">
      <h1>üç≥ Nowy projekt kuchni</h1>
      <span class="page-subtitle">Projektuj i wyceniaj zabudowƒô kuchennƒÖ</span>
    </div>
    <div class="page-actions">
      <button class="btn btn-secondary" (click)="calculateProject()" [disabled]="totalCabinetCount() === 0 || isCalculatingProject">
        <span class="btn-icon-text">üßÆ</span>
        {{ isCalculatingProject ? 'Obliczam...' : 'Wylicz projekt' }}
      </button>
    </div>
  </header>

  <!-- ============ SEKCJA 1: WIZUALIZACJA + FORMULARZ ============ -->
  <section class="main-workspace">
    <!-- Lewa kolumna: Floor plan -->
    <div class="floor-plan-column">
      <div class="panel-card">
        <div class="panel-header">
          <span class="panel-title">Widok z g√≥ry</span>
          <button class="btn btn-sm btn-primary" (click)="onAddWallRequested()">+ ≈öciana</button>
        </div>
        <div class="panel-content">
          <app-kitchen-floor-plan
            [editingCabinetId]="editingCabinetId"
            (addWallRequested)="onAddWallRequested()"
            (wallRemoved)="onWallRemoved($event)">
          </app-kitchen-floor-plan>
        </div>
        <!-- Wymiary ≈õciany -->
        <div class="wall-dimensions-bar" *ngIf="selectedWall()">
          <span class="wall-label">{{ selectedWallLabel }}:</span>
          <div class="dim-field">
            <span class="dim-label">D≈Ç.</span>
            <input type="number" [(ngModel)]="wallLength" (change)="onWallChange()">
            <span class="dim-unit">mm</span>
          </div>
          <div class="dim-field">
            <span class="dim-label">Wys.</span>
            <input type="number" [(ngModel)]="wallHeight" (change)="onWallChange()">
            <span class="dim-unit">mm</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ≈örodkowa kolumna: Widok od frontu -->
    <div class="front-view-column">
      <div class="panel-card">
        <div class="panel-header">
          <span class="panel-title">Widok od frontu</span>
          <span class="panel-info" *ngIf="selectedWall()">{{ selectedWallLabel }} ‚Ä¢ {{ wallLength }}√ó{{ wallHeight }} mm</span>
        </div>
        <div class="panel-content">
          <app-kitchen-layout [editingCabinetId]="editingCabinetId"></app-kitchen-layout>
        </div>
      </div>
    </div>

    <!-- Prawa kolumna: Formularz -->
    <div class="form-column">
      <div class="panel-card form-card">
        <div class="panel-header">
          <span class="panel-title">{{ editingCabinet ? '‚úèÔ∏è Edytuj' : '‚ûï Dodaj szafkƒô' }}</span>
          <button *ngIf="editingCabinet" class="btn btn-sm btn-secondary" (click)="onCancelEdit()">Anuluj</button>
        </div>
        <div class="panel-content">
          <app-cabinet-form
            [editingCabinet]="editingCabinet"
            (calculated)="onCabinetCalculated($event)"
            (cancelEdit)="onCancelEdit()">
          </app-cabinet-form>
        </div>
      </div>
    </div>
  </section>

  <!-- ============ SEKCJA 2: PODSUMOWANIE + LISTA SZAFEK ============ -->
  <section class="cabinets-section">
    <!-- Podsumowanie (nad listƒÖ) -->
    <div class="inline-summary" *ngIf="result && !editingCabinet">
      <div class="summary-badge">
        <span class="summary-icon">‚úì</span>
        <span class="summary-text">Ostatnia szafka: <strong>{{ result.totalCost?.toFixed(0) || '0' }} z≈Ç</strong></span>
      </div>
      <div class="summary-badge" *ngIf="cabinets().length > 0">
        <span class="summary-icon">üß±</span>
        <span class="summary-text">{{ selectedWallLabel }}: <strong>{{ cabinets().length }}</strong> szafek, <strong>{{ selectedWallTotalCost().toFixed(0) }} z≈Ç</strong></span>
        <span class="fit-indicator" [class.success]="fitsOnWall()" [class.error]="!fitsOnWall()">
          {{ fitsOnWall() ? '‚úì' : '‚úó' }}
        </span>
      </div>
      <div class="summary-badge highlight">
        <span class="summary-icon">üìê</span>
        <span class="summary-text">Projekt: <strong>{{ totalCabinetCount() }}</strong> szafek, <strong>{{ totalCost().toFixed(0) }} z≈Ç</strong></span>
      </div>
    </div>

    <!-- Lista szafek -->
    <div class="cabinets-list-card">
      <div class="list-header">
        <h3>üìã Szafki: {{ selectedWallLabel }} <span class="count-badge">{{ cabinets().length }}</span></h3>
        <div class="list-actions">
          <button
            *ngIf="cabinets().length > 0"
            class="btn btn-sm btn-secondary"
            (click)="clearSelectedWallCabinets()"
            [disabled]="editingCabinetId !== null">
            Wyczy≈õƒá
          </button>
        </div>
      </div>
      <div class="list-content">
        <app-kitchen-cabinet-list
          [cabinets]="cabinets()"
          [editingCabinetId]="editingCabinetId"
          (edit)="onEditCabinet($event)"
          (remove)="onRemoveCabinet($event)">
        </app-kitchen-cabinet-list>

        <div class="empty-list" *ngIf="cabinets().length === 0">
          <span class="empty-icon">üì¶</span>
          <p>Brak szafek na tej ≈õcianie</p>
          <small>U≈ºyj formularza powy≈ºej, aby dodaƒá szafkƒô</small>
        </div>
      </div>
    </div>
  </section>

  <!-- ============ SEKCJA 3: MATERIA≈ÅY I KOSZTY ============ -->
  <section class="costs-section" *ngIf="projectResult || totalCabinetCount() > 0">

    <!-- Podsumowanie przed kalkulacjƒÖ -->
    <div class="pre-calculation-summary" *ngIf="!projectResult && totalCabinetCount() > 0">
      <div class="summary-grid">
        <!-- Wybrana ≈õciana -->
        <div class="summary-card" *ngIf="cabinets().length > 0">
          <div class="summary-card-icon">üß±</div>
          <div class="summary-card-content">
            <h4>{{ selectedWallLabel }}</h4>
            <div class="summary-stats">
              <span>{{ cabinets().length }} szafek</span>
              <span>{{ totalWidth() }} mm zajƒôte</span>
            </div>
            <div class="summary-status" [class.success]="fitsOnWall()" [class.error]="!fitsOnWall()">
              {{ fitsOnWall() ? '‚úì Mie≈õci siƒô' : '‚úó Nie mie≈õci siƒô!' }}
              <small>({{ remainingWidth() }} mm wolne)</small>
            </div>
          </div>
          <div class="summary-card-value">{{ selectedWallTotalCost().toFixed(0) }} z≈Ç</div>
        </div>

        <!-- Ca≈Çy projekt -->
        <div class="summary-card highlight">
          <div class="summary-card-icon">üìê</div>
          <div class="summary-card-content">
            <h4>Ca≈Çy projekt</h4>
            <div class="summary-stats">
              <span>{{ walls().length }} ≈õcian</span>
              <span>{{ totalCabinetCount() }} szafek</span>
            </div>
          </div>
          <div class="summary-card-value">{{ totalCost().toFixed(0) }} z≈Ç</div>
        </div>
      </div>

      <div class="calculation-prompt">
        <p>Kliknij <strong>"Wylicz projekt"</strong>, aby uzyskaƒá szczeg√≥≈ÇowƒÖ kalkulacjƒô koszt√≥w, listƒô materia≈Ç√≥w i komponent√≥w.</p>
        <button
          class="btn btn-lg btn-primary"
          (click)="calculateProject()"
          [disabled]="editingCabinetId !== null || isCalculatingProject">
          {{ isCalculatingProject ? '‚è≥ Obliczam...' : 'üßÆ Wylicz ca≈Çy projekt' }}
        </button>
        <button class="btn btn-lg btn-secondary" (click)="clearAll()" [disabled]="editingCabinetId !== null">
          üóëÔ∏è Wyczy≈õƒá wszystko
        </button>
      </div>
    </div>

    <!-- Wyniki kalkulacji projektu -->
    <div class="project-results" *ngIf="projectResult">
      <!-- Podsumowanie koszt√≥w -->
      <div class="costs-overview card">
        <div class="card-header">
          <h2 class="card-title"><span>üí∞</span> Podsumowanie koszt√≥w</h2>
          <div class="project-status" [class.success]="projectResult.allFit" [class.warning]="!projectResult.allFit">
            {{ projectResult.allFit ? '‚úì Wszystko mie≈õci siƒô' : '‚ö†Ô∏è Niekt√≥re szafki nie mieszczƒÖ siƒô!' }}
          </div>
        </div>
        <div class="card-body">
          <div class="costs-grid">
            <div class="cost-card">
              <span class="cost-icon">ü™µ</span>
              <span class="cost-label">P≈Çyty</span>
              <span class="cost-value">{{ projectResult.totalBoardCost.toFixed(2) }} z≈Ç</span>
            </div>
            <div class="cost-card">
              <span class="cost-icon">üî©</span>
              <span class="cost-label">Komponenty</span>
              <span class="cost-value">{{ adjustedComponentCost.toFixed(2) }} z≈Ç</span>
            </div>
            <div class="cost-card">
              <span class="cost-icon">üîß</span>
              <span class="cost-label">Prace</span>
              <span class="cost-value">{{ projectResult.totalJobCost.toFixed(2) }} z≈Ç</span>
            </div>
            <div class="cost-card total">
              <span class="cost-icon">üìä</span>
              <span class="cost-label">RAZEM</span>
              <span class="cost-value">{{ adjustedTotalCost.toFixed(2) }} z≈Ç</span>
            </div>
          </div>

          <!-- Koszt odpadu - osobna sekcja -->
          <div class="waste-cost-section" *ngIf="totalWasteCost > 0">
            <div class="waste-toggle">
              <label class="toggle-label">
                <input type="checkbox" [(ngModel)]="includeWasteCost">
                <span class="toggle-text">Wlicz koszt odpadu z ciƒôcia</span>
              </label>
              <span class="waste-value" [class.included]="includeWasteCost">
                {{ includeWasteCost ? '+' : '' }}{{ totalWasteCost.toFixed(2) }} z≈Ç
              </span>
            </div>
            <small class="waste-hint">
              Odpad: {{ wasteDetails[0].quantity.toFixed(2) || 0 }} m¬≤
              (cena {{ wasteDetails[0].unitCost.toFixed(2) || 0 }} z≈Ç/m¬≤)
              ‚Äî niekt√≥re hurtownie nie doliczajƒÖ kosztu odpadu
            </small>
          </div>

          <div class="project-info">
            <span>≈öciany: {{ projectResult.wallCount }}</span>
            <span>‚Ä¢</span>
            <span>Szafki: {{ projectResult.totalCabinetCount }}</span>
          </div>
        </div>
      </div>

      <!-- Zak≈Çadki ze szczeg√≥≈Çami -->
      <div class="details-card card">
        <div class="tabs">
          <button
            class="tab-btn"
            [class.active]="activeDetailsTab === 'boards'"
            (click)="activeDetailsTab = 'boards'">
            ü™µ P≈Çyty ({{ aggregatedBoards.length }})
          </button>
          <button
            class="tab-btn"
            [class.active]="activeDetailsTab === 'components'"
            (click)="activeDetailsTab = 'components'">
            üî© Komponenty ({{ aggregatedComponents.length }})
          </button>
          <button
            class="tab-btn"
            [class.active]="activeDetailsTab === 'jobs'"
            (click)="activeDetailsTab = 'jobs'">
            üîß Prace ({{ aggregatedJobs.length }})
          </button>
          <button
            class="tab-btn"
            [class.active]="activeDetailsTab === 'walls'"
            (click)="activeDetailsTab = 'walls'">
            üß± ≈öciany ({{ projectResult.walls.length }})
          </button>
        </div>

        <div class="tab-content">
          <!-- Tab: P≈Çyty -->
          <div class="tab-panel" *ngIf="activeDetailsTab === 'boards'">
            <div class="table-container" *ngIf="aggregatedBoards.length > 0">
              <table>
                <thead>
                  <tr>
                    <th>Materia≈Ç</th>
                    <th>Wymiary (mm)</th>
                    <th>Ilo≈õƒá</th>
                    <th>Cena jedn.</th>
                    <th>Cena ca≈Çk.</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let board of aggregatedBoards">
                    <td>{{ board.material }} ({{ board.thickness }}mm)</td>
                    <td>{{ board.width }} √ó {{ board.height }}</td>
                    <td>{{ board.quantity }}</td>
                    <td>{{ board.unitCost.toFixed(2) }} z≈Ç</td>
                    <td class="text-right font-bold">{{ board.totalCost.toFixed(2) }} z≈Ç</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4"><strong>Suma p≈Çyt:</strong></td>
                    <td class="text-right"><strong>{{ projectResult.totalBoardCost.toFixed(2) }} z≈Ç</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="empty-tab" *ngIf="aggregatedBoards.length === 0">
              Brak p≈Çyt do wy≈õwietlenia
            </div>
          </div>

          <!-- Tab: Komponenty -->
          <div class="tab-panel" *ngIf="activeDetailsTab === 'components'">
            <div class="table-container" *ngIf="aggregatedComponents.length > 0">
              <table>
                <thead>
                  <tr>
                    <th>Nazwa</th>
                    <th>Typ</th>
                    <th>Ilo≈õƒá</th>
                    <th>Cena jedn.</th>
                    <th>Cena ca≈Çk.</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let comp of aggregatedComponents">
                    <td>{{ comp.name }}</td>
                    <td>{{ comp.type }}</td>
                    <td>{{ comp.quantity }}</td>
                    <td>{{ comp.unitCost.toFixed(2) }} z≈Ç</td>
                    <td class="text-right font-bold">{{ comp.totalCost.toFixed(2) }} z≈Ç</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4"><strong>Suma komponent√≥w:</strong></td>
                    <td class="text-right"><strong>{{ projectResult.totalComponentCost.toFixed(2) }} z≈Ç</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="empty-tab" *ngIf="aggregatedComponents.length === 0">
              Brak komponent√≥w do wy≈õwietlenia
            </div>
          </div>

          <!-- Tab: Prace -->
          <div class="tab-panel" *ngIf="activeDetailsTab === 'jobs'">
            <div class="table-container" *ngIf="aggregatedJobs.length > 0">
              <table>
                <thead>
                  <tr>
                    <th>Nazwa</th>
                    <th>Typ</th>
                    <th>Ilo≈õƒá</th>
                    <th>Cena jedn.</th>
                    <th>Cena ca≈Çk.</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let job of aggregatedJobs">
                    <td>{{ job.name }}</td>
                    <td>{{ job.type }}</td>
                    <td>{{ job.quantity }}</td>
                    <td>{{ job.unitCost.toFixed(2) }} z≈Ç</td>
                    <td class="text-right font-bold">{{ job.totalCost.toFixed(2) }} z≈Ç</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4"><strong>Suma prac:</strong></td>
                    <td class="text-right"><strong>{{ projectResult.totalJobCost.toFixed(2) }} z≈Ç</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="empty-tab" *ngIf="aggregatedJobs.length === 0">
              Brak prac do wy≈õwietlenia
            </div>
          </div>

          <!-- Tab: ≈öciany -->
          <div class="tab-panel" *ngIf="activeDetailsTab === 'walls'">
            <div class="walls-list">
              <div class="wall-item" *ngFor="let wall of projectResult.walls">
                <div class="wall-item-header">
                  <h4>{{ wall.wallType }}</h4>
                  <span class="wall-dims">{{ wall.widthMm }} √ó {{ wall.heightMm }} mm</span>
                  <span class="wall-status" [class.success]="wall.fits" [class.error]="!wall.fits">
                    {{ wall.fits ? '‚úì' : '‚úó' }}
                  </span>
                  <span class="wall-cost">{{ wall.wallTotalCost.toFixed(2) }} z≈Ç</span>
                </div>
                <div class="wall-item-details">
                  <span>Szafki: {{ wall.cabinetCount }}</span>
                  <span>Dolne: {{ wall.usedWidthBottom }}/{{ wall.widthMm }} mm</span>
                  <span>G√≥rne: {{ wall.usedWidthTop }}/{{ wall.widthMm }} mm</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- B≈ÇƒÖd kalkulacji -->
  <section class="error-section" *ngIf="projectError">
    <div class="alert alert-error">
      <span class="alert-icon">‚ùå</span>
      <div class="alert-content">
        <strong>B≈ÇƒÖd kalkulacji</strong>
        <p>{{ projectError }}</p>
      </div>
    </div>
  </section>

  <!-- ============ STICKY FOOTER - ZAWSZE WIDOCZNY ============ -->
  <footer class="page-footer" *ngIf="totalCabinetCount() > 0">
    <div class="footer-info">
      <span *ngIf="projectResult">
        üí∞ <strong>{{ adjustedTotalCost.toFixed(0) }} z≈Ç</strong>
        <span class="footer-details">({{ projectResult.wallCount }} ≈õcian, {{ projectResult.totalCabinetCount }} szafek)</span>
      </span>
      <span *ngIf="!projectResult">
        üìê <strong>{{ totalCabinetCount() }}</strong> szafek
        <span class="footer-details">({{ walls().length }} ≈õcian)</span>
      </span>
    </div>
    <div class="footer-actions">
      <!-- Przyciski g≈Ç√≥wne -->
      <button
        class="btn btn-primary"
        (click)="calculateProject()"
        [disabled]="totalCabinetCount() === 0 || isCalculatingProject || editingCabinetId !== null">
        <span>üßÆ</span>
        {{ isCalculatingProject ? 'Obliczam...' : 'Wylicz projekt' }}
      </button>
      <button
        class="btn btn-secondary"
        (click)="clearAll()"
        [disabled]="editingCabinetId !== null">
        <span>üóëÔ∏è</span> Wyczy≈õƒá
      </button>

      <!-- Przyciski eksportu (gdy jest kalkulacja) -->
      <ng-container *ngIf="projectResult">
        <div class="footer-divider"></div>
        <button class="btn btn-outline">
          <span>üìä</span> Excel
        </button>
        <button class="btn btn-outline">
          <span>üìÑ</span> PDF
        </button>
        <button class="btn btn-outline">
          <span>üìã</span> Instrukcja
        </button>
      </ng-container>
    </div>
  </footer>
</div>
