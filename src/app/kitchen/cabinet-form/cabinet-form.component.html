<form [formGroup]="form" class="cabinet-form">
    <!-- Formularz -->

      <!-- Wiersz 1: Nazwa i Typ szafki -->
      <div class="form-row">
        <div class="form-group flex-2">
          <label class="form-label">Nazwa (opcjonalnie)</label>
          <input type="text" class="form-control" formControlName="name" placeholder="np. Zlewozmywakowa">
        </div>
        <div class="form-group flex-2">
          <label class="form-label">Typ szafki</label>
          <select class="form-control" formControlName="kitchenCabinetType">
            <option value="BASE_TWO_DOOR">Dolna â€“ 2 drzwi</option>
            <option value="BASE_ONE_DOOR">Dolna â€“ 1 drzwi</option>
            <option value="BASE_WITH_DRAWERS">Dolna â€“ szuflady</option>
            <option value="TALL_CABINET">SÅ‚upek</option>
            <option value="CORNER_CABINET">NaroÅ¼na</option>
          </select>
        </div>
      </div>

  <!-- Wiersz 2: Wymiary (standardowe) -->
  <div class="form-row" *ngIf="visibility.width !== false">
    <div class="form-group">
      <label class="form-label">SzerokoÅ›Ä‡</label>
      <div class="input-with-unit">
        <input type="number" class="form-control" formControlName="width">
        <span class="unit">mm</span>
      </div>
      <span class="form-error" *ngIf="form.get('width')?.touched && form.get('width')?.errors">
        <ng-container *ngIf="form.get('width')?.errors?.['required']">Wymagane</ng-container>
        <ng-container *ngIf="form.get('width')?.errors?.['min']">Min: {{ form.get('width')?.errors?.['min'].min }}</ng-container>
        <ng-container *ngIf="form.get('width')?.errors?.['max']">Max: {{ form.get('width')?.errors?.['max'].max }}</ng-container>
        <ng-container *ngIf="form.get('width')?.errors?.['widthStep']">{{ form.get('width')?.errors?.['widthStep'].message }}</ng-container>
      </span>
    </div>
    <div class="form-group">
      <label class="form-label">WysokoÅ›Ä‡</label>
      <div class="input-with-unit">
        <input type="number" class="form-control" formControlName="height">
        <span class="unit">mm</span>
      </div>
      <span class="form-error" *ngIf="form.get('height')?.touched && form.get('height')?.errors">
        <ng-container *ngIf="form.get('height')?.errors?.['required']">Wymagane</ng-container>
        <ng-container *ngIf="form.get('height')?.errors?.['min']">Min: {{ form.get('height')?.errors?.['min'].min }}</ng-container>
        <ng-container *ngIf="form.get('height')?.errors?.['max']">Max: {{ form.get('height')?.errors?.['max'].max }}</ng-container>
      </span>
    </div>
    <div class="form-group">
      <label class="form-label">GÅ‚Ä™bokoÅ›Ä‡</label>
      <div class="input-with-unit">
        <input type="number" class="form-control" formControlName="depth">
        <span class="unit">mm</span>
      </div>
      <span class="form-error" *ngIf="form.get('depth')?.touched && form.get('depth')?.errors">
        <ng-container *ngIf="form.get('depth')?.errors?.['required']">Wymagane</ng-container>
        <ng-container *ngIf="form.get('depth')?.errors?.['min']">Min: {{ form.get('depth')?.errors?.['min'].min }}</ng-container>
        <ng-container *ngIf="form.get('depth')?.errors?.['max']">Max: {{ form.get('depth')?.errors?.['max'].max }}</ng-container>
      </span>
    </div>
  </div>

  <!-- Sekcja szafki naroÅ¼nej (CORNER_CABINET) -->
  <div *ngIf="visibility.cornerWidthA" class="corner-section">
    <h4 class="section-title">Konfiguracja naroÅ¼nika</h4>

    <!-- Typ montaÅ¼u: dolna/gÃ³rna -->
    <div class="form-row">
      <div class="form-group flex-2">
        <label class="form-label">Typ montaÅ¼u</label>
        <select class="form-control" formControlName="isUpperCorner">
          <option [ngValue]="false">Dolna (z blatem)</option>
          <option [ngValue]="true">GÃ³rna (wiszÄ…ca)</option>
        </select>
      </div>
      <div class="form-group flex-2">
        <label class="form-label">System organizacji</label>
        <select class="form-control" formControlName="cornerMechanism">
          <option *ngFor="let m of availableCornerMechanisms" [value]="m.value">{{ m.label }}</option>
        </select>
      </div>
    </div>

    <!-- Wymiary naroÅ¼nika -->
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">SzerokoÅ›Ä‡ A</label>
        <div class="input-with-unit">
          <input type="number" class="form-control" formControlName="cornerWidthA"
                 [min]="cornerConstraints.widthMin" [max]="cornerConstraints.widthMax"
                 [step]="cornerConstraints.widthStep">
          <span class="unit">mm</span>
        </div>
        <span class="form-hint">Åšciana gÅ‚Ã³wna</span>
        <span class="form-error" *ngIf="form.get('cornerWidthA')?.touched && form.get('cornerWidthA')?.errors">
          <ng-container *ngIf="form.get('cornerWidthA')?.errors?.['min']">Min: {{ cornerConstraints.widthMin }}</ng-container>
          <ng-container *ngIf="form.get('cornerWidthA')?.errors?.['max']">Max: {{ cornerConstraints.widthMax }}</ng-container>
        </span>
      </div>
      <div class="form-group">
        <label class="form-label">SzerokoÅ›Ä‡ B</label>
        <div class="input-with-unit">
          <input type="number" class="form-control" formControlName="cornerWidthB"
                 [min]="cornerConstraints.widthMin" [max]="cornerConstraints.widthMax"
                 [step]="cornerConstraints.widthStep">
          <span class="unit">mm</span>
        </div>
        <span class="form-hint">Åšciana boczna</span>
        <span class="form-error" *ngIf="form.get('cornerWidthB')?.touched && form.get('cornerWidthB')?.errors">
          <ng-container *ngIf="form.get('cornerWidthB')?.errors?.['min']">Min: {{ cornerConstraints.widthMin }}</ng-container>
          <ng-container *ngIf="form.get('cornerWidthB')?.errors?.['max']">Max: {{ cornerConstraints.widthMax }}</ng-container>
        </span>
      </div>
      <div class="form-group">
        <label class="form-label">WysokoÅ›Ä‡</label>
        <div class="input-with-unit">
          <input type="number" class="form-control" formControlName="height">
          <span class="unit">mm</span>
        </div>
        <span class="form-error" *ngIf="form.get('height')?.touched && form.get('height')?.errors">
          <ng-container *ngIf="form.get('height')?.errors?.['min']">Min: {{ form.get('height')?.errors?.['min'].min }}</ng-container>
          <ng-container *ngIf="form.get('height')?.errors?.['max']">Max: {{ form.get('height')?.errors?.['max'].max }}</ng-container>
        </span>
      </div>
      <div class="form-group">
        <label class="form-label">GÅ‚Ä™bokoÅ›Ä‡</label>
        <div class="input-with-unit">
          <input type="number" class="form-control" formControlName="depth">
          <span class="unit">mm</span>
        </div>
        <span class="form-error" *ngIf="form.get('depth')?.touched && form.get('depth')?.errors">
          <ng-container *ngIf="form.get('depth')?.errors?.['min']">Min: {{ form.get('depth')?.errors?.['min'].min }}</ng-container>
          <ng-container *ngIf="form.get('depth')?.errors?.['max']">Max: {{ form.get('depth')?.errors?.['max'].max }}</ng-container>
        </span>
      </div>
    </div>

    <!-- Liczba pÃ³Å‚ek (tylko dla FIXED_SHELVES) -->
    <div class="form-row" *ngIf="visibility.cornerShelfQuantity">
      <div class="form-group">
        <label class="form-label">Liczba pÃ³Å‚ek</label>
        <input type="number" class="form-control" formControlName="cornerShelfQuantity"
               [min]="cornerConstraints.shelfMin" [max]="cornerConstraints.shelfMax">
        <span class="form-error" *ngIf="form.get('cornerShelfQuantity')?.touched && form.get('cornerShelfQuantity')?.errors">
          <ng-container *ngIf="form.get('cornerShelfQuantity')?.errors?.['min']">Min: {{ cornerConstraints.shelfMin }}</ng-container>
          <ng-container *ngIf="form.get('cornerShelfQuantity')?.errors?.['max']">Max: {{ cornerConstraints.shelfMax }}</ng-container>
        </span>
      </div>
    </div>

    <!-- Wizualizacja ksztaÅ‚tu L -->
    <div class="corner-preview">
      <svg viewBox="0 0 200 200" class="corner-svg">
        <!-- KsztaÅ‚t L -->
        <polygon
          [attr.points]="'10,10 ' + (10 + 80) + ',10 ' + (10 + 80) + ',' + (10 + 40) + ' ' + (10 + 40) + ',' + (10 + 40) + ' ' + (10 + 40) + ',' + (10 + 80) + ' 10,' + (10 + 80)"
          fill="#e8d4a8" stroke="#8B4513" stroke-width="2"/>
        <!-- Etykiety wymiarÃ³w -->
        <text x="50" y="8" font-size="10" text-anchor="middle">A: {{ form.get('cornerWidthA')?.value }}mm</text>
        <text x="5" y="55" font-size="10" text-anchor="middle" transform="rotate(-90, 5, 55)">B: {{ form.get('cornerWidthB')?.value }}mm</text>
        <!-- Ikona mechanizmu -->
        <text x="100" y="120" font-size="24" text-anchor="middle">
          {{ currentCornerMechanism === 'MAGIC_CORNER' ? 'ðŸª„' :
             currentCornerMechanism === 'CAROUSEL_270' || currentCornerMechanism === 'CAROUSEL_360' ? 'ðŸŽ ' :
             currentCornerMechanism === 'LE_MANS' ? 'ðŸ«˜' :
             currentCornerMechanism === 'FIXED_SHELVES' ? 'ðŸ“š' : 'ðŸ“¦' }}
        </text>
        <text x="100" y="140" font-size="10" text-anchor="middle">{{ currentCornerMechanismLabel }}</text>
      </svg>
    </div>
  </div>

  <!-- Wiersz 3: Opcje dodatkowe -->
  <div class="form-row">
    <div class="form-group">
      <label class="form-label">Typ otwarcia</label>
      <select class="form-control" formControlName="openingType">
        <option *ngFor="let opt of openingTypes" [value]="opt.value">{{ opt.label }}</option>
      </select>
    </div>
    <div class="form-group" *ngIf="visibility.shelfQuantity">
      <label class="form-label">PÃ³Å‚ki</label>
      <input type="number" class="form-control" formControlName="shelfQuantity">
      <span class="form-error" *ngIf="form.get('shelfQuantity')?.touched && form.get('shelfQuantity')?.errors">
        <ng-container *ngIf="form.get('shelfQuantity')?.errors?.['min']">Min: {{ form.get('shelfQuantity')?.errors?.['min'].min }}</ng-container>
        <ng-container *ngIf="form.get('shelfQuantity')?.errors?.['max']">Max: {{ form.get('shelfQuantity')?.errors?.['max'].max }}</ng-container>
      </span>
    </div>
    <div class="form-group" *ngIf="visibility.drawerQuantity">
      <label class="form-label">IloÅ›Ä‡ szuflad</label>
      <input type="number" class="form-control" formControlName="drawerQuantity">
      <span class="form-error" *ngIf="form.get('drawerQuantity')?.touched && form.get('drawerQuantity')?.errors">
        <ng-container *ngIf="form.get('drawerQuantity')?.errors?.['required']">Wymagane</ng-container>
        <ng-container *ngIf="form.get('drawerQuantity')?.errors?.['min']">Min: {{ form.get('drawerQuantity')?.errors?.['min'].min }}</ng-container>
        <ng-container *ngIf="form.get('drawerQuantity')?.errors?.['max']">Max: {{ form.get('drawerQuantity')?.errors?.['max'].max }}</ng-container>
      </span>
    </div>
    <div class="form-group" *ngIf="visibility.drawerModel">
      <label class="form-label">System szuflad</label>
      <select class="form-control" formControlName="drawerModel">
        <option value="ANTARO_TANDEMBOX">Blum Antaro Tandembox</option>
        <option value="SEVROLL_BALL">Sevroll Ball</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Pozycja Y</label>
      <div class="input-with-unit">
        <input type="number" class="form-control" formControlName="positionY" placeholder="0">
        <span class="unit">mm</span>
      </div>
      <span class="form-hint">0=dolna, 1400=wiszÄ…ca</span>
    </div>
  </div>

  <!-- Sekcja segmentÃ³w (dla TALL_CABINET) -->
  <div *ngIf="visibility.segments" class="segments-section">
    <h4 class="section-title">Konfiguracja segmentÃ³w</h4>

    <div class="segments-layout">
      <!-- Lewa strona: wizualizer -->
      <div class="segments-visualizer-column">
        <app-segment-visualizer
          [segmentsArray]="segmentsArray"
          [netHeight]="netCabinetHeight"
          [selectedIndex]="selectedSegmentIndex"
          (segmentSelected)="selectSegment($event)"
          (orderChanged)="onSegmentsReordered()">
        </app-segment-visualizer>
      </div>

      <!-- Prawa strona: formularz wybranego segmentu -->
      <div class="segments-form-column">
        <ng-container *ngIf="selectedSegmentForm; else noSegmentSelected">
          <app-segment-form
            [segmentForm]="selectedSegmentForm"
            [segmentIndex]="selectedSegmentIndex"
            (remove)="removeSegment(selectedSegmentIndex)">
          </app-segment-form>
        </ng-container>

        <ng-template #noSegmentSelected>
          <div class="no-segment-hint">
            <p>Kliknij segment na wizualizacji, aby go edytowaÄ‡.</p>
          </div>
        </ng-template>

        <button type="button" class="btn btn-secondary btn-add-segment" (click)="addSegment()">
          + Dodaj segment
        </button>
      </div>
    </div>

    <!-- BÅ‚Ä…d walidacji wysokoÅ›ci segmentÃ³w -->
    <div *ngIf="segmentHeightError" class="segments-error">
      {{ segmentHeightError }}
    </div>
  </div>

      <!-- Przyciski -->
      <div class="form-actions">
        <button type="button" class="btn btn-primary" (click)="calculate()" [disabled]="loading || form.invalid">
          <span *ngIf="loading" class="spinner"></span>
          {{ isEditMode ? 'ðŸ’¾ Zapisz' : 'âž• Dodaj szafkÄ™' }}
        </button>
        <button
          *ngIf="isEditMode"
          type="button"
          class="btn btn-secondary"
          (click)="onCancel()"
          [disabled]="loading">
          Anuluj
        </button>
      </div>

</form>
