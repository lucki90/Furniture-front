<div class="layout-container">
  <h4>Widok od frontu: {{ wallLabel() }}</h4>

  <div *ngIf="cabinetPositions().length === 0" class="empty-state">
    Dodaj szafki, aby zobaczyć wizualizację
  </div>

  <div *ngIf="cabinetPositions().length > 0" class="visualization-wrapper">
    <p class="wall-info">
      {{ wallLabel() }}: {{ wall().length }} mm |
      Dolne: {{ usedWidthBottom() }}/{{ wall().length }} mm |
      Górne: {{ usedWidthTop() }}/{{ wall().length }} mm
      <span *ngIf="!fitsOnWall()" class="warning-inline">⚠️ Nie mieści się!</span>
      <span *ngIf="fitsOnWall()" class="success-inline">✓</span>
    </p>

    <!-- Wall visualization - SVG -->
    <div class="wall-view-wrapper">
      <!-- Zone labels (po lewej) -->
      <div class="zone-labels" [style.height.px]="totalHeight">
        <span class="zone-label" [style.top.px]="topZoneY" [style.height.px]="topZoneHeight">Górne</span>
        <span class="zone-label gap-label" [style.top.px]="gapZoneY" [style.height.px]="gapZoneHeight"></span>
        <span class="zone-label counter-label" [style.top.px]="counterZoneY" [style.height.px]="counterZoneHeight">Blat</span>
        <span class="zone-label" [style.top.px]="bottomZoneY" [style.height.px]="bottomZoneHeight">Dolne</span>
      </div>

      <!-- SVG visualization -->
      <svg class="wall-svg"
           [attr.width]="wallDisplayWidth()"
           [attr.height]="totalHeight"
           [class.overflow]="!fitsOnWall()">

        <!-- Definicje gradientów -->
        <defs>
          <!-- Gradient dla frontu -->
          <linearGradient id="frontGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#e8e8e8;stop-opacity:1" />
          </linearGradient>
          <!-- Gradient dla frontu otwartego -->
          <linearGradient id="openFrontGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#f5f5f5;stop-opacity:0.3" />
            <stop offset="100%" style="stop-color:#e0e0e0;stop-opacity:0.3" />
          </linearGradient>
          <!-- Gradient dla blatu -->
          <linearGradient id="countertopGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#8d6e63;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#6d4c41;stop-opacity:1" />
          </linearGradient>
        </defs>

        <!-- Tło stref -->
        <!-- Strefa górna -->
        <rect [attr.x]="0" [attr.y]="topZoneY"
              [attr.width]="wallDisplayWidth()" [attr.height]="topZoneHeight"
              class="zone-bg upper-zone-bg"/>

        <!-- Przerwa (ściana) -->
        <rect [attr.x]="0" [attr.y]="gapZoneY"
              [attr.width]="wallDisplayWidth()" [attr.height]="gapZoneHeight"
              class="zone-bg gap-zone-bg"/>

        <!-- Blat -->
        <rect [attr.x]="0" [attr.y]="counterZoneY"
              [attr.width]="wallDisplayWidth()" [attr.height]="counterZoneHeight"
              fill="url(#countertopGradient)" class="countertop-rect"/>

        <!-- Strefa dolna -->
        <rect [attr.x]="0" [attr.y]="bottomZoneY"
              [attr.width]="wallDisplayWidth()" [attr.height]="bottomZoneHeight"
              class="zone-bg lower-zone-bg"/>

        <!-- Szafki -->
        <g *ngFor="let pos of visualPositions(); let i = index" class="cabinet-group"
           [class.editing]="isEditing(pos.cabinetId)">

          <!-- Korpus szafki (tło) -->
          <rect [attr.x]="pos.displayX"
                [attr.y]="pos.displayY"
                [attr.width]="pos.displayWidth"
                [attr.height]="pos.displayHeight - pos.feetHeight"
                [class.cabinet-body]="true"
                [class.cabinet-bottom]="pos.zone === 'BOTTOM'"
                [class.cabinet-top]="pos.zone === 'TOP'"
                [class.cabinet-full]="pos.zone === 'FULL'"
                [class.cabinet-corner]="pos.isCorner"
                [class.overflow]="pos.isOverflow"
                rx="1">
            <title>{{ (pos.name ? pos.name + ': ' : '') + pos.width + '×' + pos.height + '×' + pos.depth + 'mm' }}</title>
          </rect>

          <!-- Fronty -->
          <g class="fronts-group">
            <ng-container *ngFor="let front of pos.fronts">
              <!-- Front normalny (drzwi/szuflada) -->
              <rect *ngIf="front.type !== 'OPEN'"
                    [attr.x]="front.x"
                    [attr.y]="front.y"
                    [attr.width]="front.width"
                    [attr.height]="front.height"
                    fill="url(#frontGradient)"
                    class="front-rect"
                    [class.drawer-front]="front.type === 'DRAWER'"
                    rx="0.5">
              </rect>
              <!-- Front otwarty (półki) -->
              <rect *ngIf="front.type === 'OPEN'"
                    [attr.x]="front.x"
                    [attr.y]="front.y"
                    [attr.width]="front.width"
                    [attr.height]="front.height"
                    fill="url(#openFrontGradient)"
                    class="front-rect open-front"
                    stroke="#bdbdbd"
                    stroke-dasharray="2 2"
                    rx="0.5">
              </rect>
            </ng-container>
          </g>

          <!-- Uchwyty -->
          <g class="handles-group">
            <line *ngFor="let handle of pos.handles"
                  [attr.x1]="handle.x1"
                  [attr.y1]="handle.y1"
                  [attr.x2]="handle.x2"
                  [attr.y2]="handle.y2"
                  class="handle-line"
                  stroke-linecap="round"/>
          </g>

          <!-- Nóżki (zamiast cokołu) -->
          <g *ngIf="pos.feetHeight > 0" class="feet-group">
            <circle *ngFor="let foot of pos.feet"
                    [attr.cx]="foot.x"
                    [attr.cy]="foot.y"
                    r="2"
                    class="foot-circle">
            </circle>
          </g>

          <!-- Etykieta szafki -->
          <text [attr.x]="pos.displayX + pos.displayWidth / 2"
                [attr.y]="pos.displayY + (pos.displayHeight - pos.feetHeight) / 2"
                class="cabinet-label-text"
                text-anchor="middle"
                dominant-baseline="middle">
            {{ getCabinetLabel(pos, i) }}
          </text>

          <!-- Ikona narożnika -->
          <text *ngIf="pos.isCorner"
                [attr.x]="pos.displayX + pos.displayWidth - 6"
                [attr.y]="pos.displayY + 8"
                class="corner-icon-text"
                text-anchor="middle">⌐</text>

          <!-- Wskaźnik różnicy wysokości -->
          <g *ngIf="pos.heightDiff" class="dimension-indicator">
            <rect [attr.x]="pos.displayX + pos.displayWidth - 18"
                  [attr.y]="pos.displayY + 2"
                  width="16" height="10"
                  [class.indicator-bg]="true"
                  [class.indicator-warning]="isSignificantDiff(pos.heightDiff)"
                  rx="2"/>
            <text [attr.x]="pos.displayX + pos.displayWidth - 10"
                  [attr.y]="pos.displayY + 9"
                  class="indicator-text"
                  text-anchor="middle"
                  [class.indicator-warning-text]="isSignificantDiff(pos.heightDiff)">
              h{{ formatDimensionDiff(pos.heightDiff) }}
            </text>
          </g>

          <!-- Wskaźnik różnicy głębokości -->
          <g *ngIf="pos.depthDiff" class="dimension-indicator">
            <rect [attr.x]="pos.displayX + 2"
                  [attr.y]="pos.displayY + 2"
                  width="16" height="10"
                  [class.indicator-bg]="true"
                  [class.indicator-warning]="isSignificantDiff(pos.depthDiff)"
                  rx="2"/>
            <text [attr.x]="pos.displayX + 10"
                  [attr.y]="pos.displayY + 9"
                  class="indicator-text"
                  text-anchor="middle"
                  [class.indicator-warning-text]="isSignificantDiff(pos.depthDiff)">
              d{{ formatDimensionDiff(pos.depthDiff) }}
            </text>
          </g>
        </g>

        <!-- Wolne miejsce - górne -->
        <rect *ngIf="hasHangingCabinets() && remainingTopSpaceWidth() > 0"
              [attr.x]="remainingTopSpaceX()"
              [attr.y]="topZoneY"
              [attr.width]="remainingTopSpaceWidth()"
              [attr.height]="topZoneHeight"
              class="remaining-space-rect"/>

        <!-- Wolne miejsce - dolne -->
        <rect *ngIf="hasBottomCabinets() && remainingBottomSpaceWidth() > 0"
              [attr.x]="remainingBottomSpaceX()"
              [attr.y]="bottomZoneY"
              [attr.width]="remainingBottomSpaceWidth()"
              [attr.height]="bottomZoneHeight"
              class="remaining-space-rect"/>

        <!-- Podłoga -->
        <line [attr.x1]="0" [attr.y1]="totalHeight - 1"
              [attr.x2]="wallDisplayWidth()" [attr.y2]="totalHeight - 1"
              class="floor-line"/>

      </svg>
    </div>

    <div class="legend">
      <span class="legend-item">
        <span class="legend-box cabinet-bottom-legend"></span> Dolna
      </span>
      <span class="legend-item">
        <span class="legend-box cabinet-hanging-legend"></span> Górna
      </span>
      <span class="legend-item">
        <span class="legend-box cabinet-full-legend"></span> Słupek
      </span>
      <span class="legend-item">
        <span class="legend-box cabinet-corner-legend"></span> Narożna
      </span>
      <span class="legend-item">
        <span class="legend-box counter-legend"></span> Blat
      </span>
      <span class="legend-item legend-indicator">
        <span class="legend-box indicator-legend"></span> h/d = różnica wys./głęb.
      </span>
    </div>
  </div>
</div>
